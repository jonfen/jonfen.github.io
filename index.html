<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Visual Farnsworth CW Trainer</title>
    <link rel="stylesheet" href="style.css">
    <script language="javascript" src="trainer.js"></script>
    <script language="javascript" src="session2.js"></script>
  </head>
  <body id="home">
    <a name="top"></a>
    <div id="player">
      <h1>A Visual Farnsworth CW Trainer</h1>
      <div id="links">
        <a href="#about">About</a>
        <a href="#help">Help</a>
      </div>
      <div id="output"></div>
      <div id="controls">
        <div class="container">
          <h3>Elements</h3>
          <select class="select" id="wpmSelect">
            <option value="15">15 WPM</option>
            <option value="18">18 WPM</option>
            <option value="20">20 WPM</option>
            <option value="23">23 WPM</option>
            <option value="25">25 WPM</option>
            <option value="30">30 WPM</option>
          </select>
        </div>
        <div class="container">
          <h3>Farnsworth</h3>
          <select class="select" id="fwSelect">
            <option value="3">3 WPM</option>
            <option value="5">5 WPM</option>
            <option value="8">8 WPM</option>
            <option value="10">10 WPM</option>
            <option value="13">13 WPM</option>
            <option value="15">15 WPM</option>
            <option value="18">18 WPM</option>
            <option value="20">20 WPM</option>
            <option value="25">25 WPM</option>
            <option value="30">30 WPM</option>
          </select>
        </div>
        <div class="container">
          <h3>Mode</h3>
          <select class="select" id="modeSelect">
            <option value="straight">Straight</option>
            <option value="random_repeat">Random &amp; Repeat</option>
            <option value="random_no_repeat">Random &amp; No Repeat</option>
          </select>
        </div>
        <div class="container">
          <h3>Type</h3>
          <select class="select" id="typeSelect">
            <option value="cwops">CWOps Level 1</option>
            <option value="words">Top CW Words</option>
            <option value="random">Random Groups</option>
          </select>
        </div>
        <div class="container">
          <h3>CWOps Session</h3>
          <select class="select" id="sessionSelect">
            <option value="1">Session 1: t, e, a, n</option>
            <option value="2">Session 2: i, o, s, 1, 4</option>
            <option value="3">Session 3: d, h, l, r, 2, 5</option>
            <option value="4">Session 4: c, u</option>
            <option value="5">Session 5: m, w, 3, 6, ?</option>
            <option value="6">Session 6: f, y</option>
            <option value="7">Session 7: g, p, 7, 9, /</option>
            <option value="8">Session 8: b, v</option>
            <option value="9">Session 9: j, k, 0, 8, &lt;BT&gt;</option>
            <option value="10">Session 10: q, x, z, &lt;BK&gt;</option>
            <option value="11">Session 11: -</option>
            <option value="12">Session 12</option>
            <option value="13">Session 13: &lt;SK&gt;</option>
          </select>
        </div>        
        <div class="container cgroup" id="selectedType"></div>
      </div>
      <div>
        <div id="sendText"></div>
      </div>
      <input type="button" id="textButton" value="New Text" />
      <input type="button" id="sendButton" value="Send" />
      <input type="button" id="cancelButton" value="Stop" disabled="true" />
      <div id="explainer">
        <a name="about"></a>
        <h2>About</h2>
        <p>This trainer is a small personal project designed to play
          with learning morse code through the Farnsworth method.</p>
        
        <p>The main difference between this trainer and others is that I
          am experimenting with visual reinforcement by displaying the
          character currently being sent. It is my hope that this will
          help form a stronger link between the <em>sound</em> of CW
          and the <em>meaning</em> of the sound.</p>

        <p>This page should work in any modern desktop or mobile
          browser, including Edge, Safari, Chrome, Firefox, and
          Opera. But, please be aware that it does not work in
          Internet Explorer, because IE does not support the Web Audio
          API.</p>
        
        <a href="#top">Top</a>

        <a name="help"></a>
        <h2>Help</h2>
        <dl>
          <dt>New Text</dt>
          <dd>Generate a new practice text based on current settings</dd>

          <dt>Send</dt>
          <dd>Start sending immediately</dd>

          <dt>Stop</dt>
          <dd>Stop sending immediately</dd>
          
          <dt>Elements (Speed)</dt>
          <dd>Sets the speed used for the spacing of dits and dahs
            within each individual character. It is suggested that you
            not put this below 20WPM.</dd>

          <dt>Farnsworth (Speed)</dt>
          <dd>Sets the speed that will be used for spacing inbetween
            each character. Start slow, and gradually increase the
            Farnsworth speed until you have difficulty copying.</dd>

          <dt>Display</dt>
          <dd>
            <p>There are three possible options for display mode.</p>
            <ol>
              <li><em>Immediate</em>: The character is displayed during
                the transmission of the character only, but hidden
                as soon as the character has been transmitted.</li>
              <li><em>Lingering</em>: The character is displayed during
                the transmission of the character, but will hang around
                until the next character is transmitted.</li>
              <li><em>Delayed</em>: The character will be displayed
                starting immediately <em>after</em> the character has
                been sent.</li>
            </ol>

          <dt>Type</dt>
          <dd>Select between <em>Top CW Words</em>, which will display
            a random selection of the top 100 most common words, or
            <em>Random Groups</em>, which will send random groups of
            five characters each.</dd>

          <dt>Call Signs</dt>
          <dd>If checked, include randomly generated call signs in the
            <em>Top CW Words</em>.</dd>

          <dt>Prosigns</dt>
          <dd>If checked, include prosigns in the <em>Top CW Words</em>.
            Prosigns include
            <strong>AR</strong> (&ldquo;DISREGARD&rdquo;),
            <strong>AS</strong> (&ldquo;WAIT&rdquo;),
            <strong>BT</strong> (&ldquo;NEW PARAGRAPH&rdquo;),
            <strong>SK</strong> (&ldquo;END OF CONTACT&rdquo;),
            <strong>KN</strong> (&ldquo;GO AHEAD&rdquo;), and
            <strong>BK</strong> (&ldquo;BREAK&rdquo;).</dd>

          <dt>Letters</dt>
          <dd>If checked, include the characters A&ndash;Z in the
            randomly generated character group.</dd>

          <dt>Numbers</dt>
          <dd>If checked, include the characters 0&ndash;9 in the
            randomly generated character groups.</dd>

          <dt>Symbols</dt>
          <dd>If checked, include the characters &ldquo;.&rdquo;
            (period), &ldquo;,&rdquo; (comma), &ldquo;?&rdquo;
            (question mark), &ldquo;=&rdquo; (equal sign), and
            &rdquo;/&ldquo; (slash) in the randomly generated
            character groups.</dd>
        </dl>
        <a href="#top">Top</a>
            
      </div>
      <div id="footer">
        Copyright &copy; 2019, Seth Morabito &lt;web@loomcom.com&gt;.

        Licensed under <a href="https://www.gnu.org/licenses/agpl-3.0.en.html">AGPL 3</a>.
      </div>
    </div>


    <script language="javascript">
      const DEFAULT_WPM = 20;
      const DEFAULT_FARNSWORTH = 15;
      const DEFAULT_GROUP_COUNT = 50;
      const DEFAULT_GROUP_LEN = 5;

          const wordsBlock = `
<div class="container">
    <h3>Call Signs</h3>
    <input type="checkbox" id="callsignsCheckbox" />
</div>
<div class="container">
    <h3>Prosigns</h3>
    <input type="checkbox" id="prosignsCheckbox" />
</div>
`;

          const groupsBlock = `
<div class="container">
    <h3>Letters</h3>
    <input type="checkbox" id="lettersCheckbox" />
</div>
<div class="container">
    <h3>Numbers</h3>
    <input type="checkbox" id="numbersCheckbox" />
</div>
<div class="container">
    <h3>Symbols</h3>
    <input type="checkbox" id="symbolsCheckbox" />
</div>
`;      
      var text;
      var text_list;

      var charNum = 0;

      function $(id) {
          return document.getElementById(id);
      }

      function disableUi() {
          const type = $("typeSelect").value;

          $("wpmSelect").disabled = true;
          $("fwSelect").disabled = true;
          $("textButton").disabled = true;
          $("sendButton").disabled = true;
          $("cancelButton").disabled = false;
          $("modeSelect").disabled = true;
          $("sessionSelect").disabled = true;
          $("sendText").disabled = true;
          $("typeSelect").disabled = true;
          if (type === 'words') {
              $("callsignsCheckbox").disabled = true;
              $("prosignsCheckbox").disabled = true;
          } else if (type === 'random') {
              $("lettersCheckbox").disabled = true;
              $("numbersCheckbox").disabled = true;
              $("symbolsCheckbox").disabled = true;
          }
      }

      function enableUi() {
          const type = $("typeSelect").value;

          $("output").innerHTML = "";
          $("wpmSelect").disabled = false;
          $("fwSelect").disabled = false;
          $("textButton").disabled = false;
          $("sendButton").disabled = false;
          $("cancelButton").disabled = true;
          $("modeSelect").disabled = false;
          $("sessionSelect").disabled = false;          
          $("sendText").disabled = false;
          $("typeSelect").disabled = false;
          if (type === 'words') {
              $("callsignsCheckbox").disabled = false;
              $("prosignsCheckbox").disabled = false;
          } else if (type === 'random') {
              $("lettersCheckbox").disabled = false;
              $("numbersCheckbox").disabled = false;
              $("symbolsCheckbox").disabled = false;
          }
      }

      function updateConfig() {
          const type = $("typeSelect").value;
          $("textButton").value = 'New Text';
          if (type === 'words') {
              $("selectedType").innerHTML = wordsBlock;

              $("callsignsCheckbox").checked = trainer.enableCallsigns;
              $("prosignsCheckbox").checked = trainer.enableProsigns;

              $("callsignsCheckbox").onclick = function() {
                  trainer.enableCallsigns = $("callsignsCheckbox").checked;
                  updateConfig();
              };
              $("prosignsCheckbox").onclick = function() {
                  trainer.enableProsigns = $("prosignsCheckbox").checked;
                  updateConfig();
              };
          } else if (type === 'cwops') {
            $("textButton").value = 'Shuffle';
            $("selectedType").innerHTML = '';
          } else {
              $("selectedType").innerHTML = groupsBlock;

              $("lettersCheckbox").checked = trainer.enableLetters;
              $("numbersCheckbox").checked = trainer.enableNumbers;
              $("symbolsCheckbox").checked = trainer.enableSymbols;

              $("lettersCheckbox").onclick = function() {
                  trainer.enableLetters = $("lettersCheckbox").checked;
                  updateConfig();
              };
              $("numbersCheckbox").onclick = function() {
                  trainer.enableNumbers = $("numbersCheckbox").checked;
                  updateConfig();
              };
              $("symbolsCheckbox").onclick = function() {
                  trainer.enableSymbols = $("symbolsCheckbox").checked;
                  updateConfig();
              };
          }

          generateText();
      }

      function showChar(c) {
          var newText = text.replace(/@/g, '');

          charNum += c.length;
          $("output").innerHTML = "";
        
          newText = 
              "<span class=\"hilighted\">" + newText.substring(0, charNum) + "</span>" +
              newText.substring(charNum, newText.length);

          if (text[charNum + 1] === ' ') {
              charNum++;
          }

          $("sendText").innerHTML = newText;
      }

      function hideChar(c) {
          $("output").innerHTML = c;
      }

      $("wpmSelect").value = DEFAULT_WPM;
      $("fwSelect").value = DEFAULT_FARNSWORTH;

      let trainer = new CwTrainer(DEFAULT_WPM,
                                  DEFAULT_FARNSWORTH,
                                  showChar,
                                  hideChar,
                                  enableUi,
                                  enableUi);

      function cancel() {
          trainer.cancel();
      }

      function generateText() {
          charNum = 0;

          if ($("typeSelect").value === 'words') {
              text_list = trainer.randomText(75);
              text = text_list.join(" ");
          } else if ($("typeSelect").value === 'cwops') {
              text_list = trainer.randomCWOps($("sessionSelect").value, $("modeSelect").value);
              text = text_list.join(" ");
          } else {
              text_list = trainer.randomGroups(60, 5);
              text = text_list.join(" ");
          }
          
          $("sendText").innerHTML =
              text.replace(/@/g, '');
      }

      function send() {
          // Webkit requires that a user interaction unsuspend
          // the audio context, otherwise no audio.
          trainer.unsuspend();
          disableUi();
          charNum = 0;
          trainer.sendText(text);
      }

      function setWpm() {
          trainer.setWpm($("wpmSelect").value,
                         $("fwSelect").value);
      }

      $("wpmSelect").onchange = setWpm;
      $("fwSelect").onchange = setWpm;
      $("typeSelect").onchange = updateConfig;
      $("modeSelect").onchange = generateText;
      $("sessionSelect").onchange = generateText;

      $("textButton").onclick = generateText;
      $("sendButton").onclick = send;
      $("cancelButton").onclick = cancel;

      updateConfig();
      generateText();
    </script>
  </body>
</html>
